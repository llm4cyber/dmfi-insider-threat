# Dual-Modality Insider Threat Detection (DMFI) 

This repository contains the source code and instructions for reproducing the results of our paper submitted to [a top-tier data mining conference in 2025].

> Note: For anonymity, author and affiliation information have been removed.

## Contents
- Preprocessing scripts for CERT dataset
- LoRA fine-tuning pipeline using LLaMA-Factory
- Semantic/Behavioral prompt generation
- Evaluation code and baseline comparisons

The full architecture is shown in the PDF below:

<img src="./assets/Structrue.png" alt="main" style="zoom: 33%;" />

## Preprocessing Pipeline

<img src="./assets/Compress_Sequence.png" alt="main" style="zoom: 33%;" />

Illustrative example of behavior sequence compression. 
The left table organizes raw user actions using the 4W schema (When, Where, What, Which).
On the right, we compare the original verbose sequence with a compressed version generated by our 4W-guided abstraction strategy.
While the original form enumerates each atomic behavior separately, the compressed version merges related actions into concise natural language.
This reduces token length (from 49 to 31 in this case) while retaining key behavioral semantics.

## ğŸ—‚ï¸ Folder Structure

```
dmfi/
â”œâ”€â”€ assets/
â”œâ”€â”€ deployment/
â”‚   â””â”€â”€ README_DeepSeek_Finetuning.md
â”œâ”€â”€ preprocess/
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ behavior_sequence/
â”‚   â”‚   â”œâ”€â”€ semantic_content/
â”‚   â”‚   â””â”€â”€ alpaca/
â”‚   â””â”€â”€ output/
â”‚       â”œâ”€â”€ log_split/
â”‚       â””â”€â”€ log_merged/
â”œâ”€â”€ step1_log_split.py
â”œâ”€â”€ step2_log_merge.py
â”œâ”€â”€ step3_log_labeling.py
â”œâ”€â”€ step4_1_sequence_feature_engineering.py
â”œâ”€â”€ step4_2_semantic_feature_engineering.py
â”œâ”€â”€ step5_alpaca_feature_engineering.py
â”œâ”€â”€ utils_for_feature.py
â””â”€â”€ config.yaml
```

## ğŸ¤– LLM Finetuning 

### âœ… Environment

- **Hardware**:
  - 4Ã— NVIDIA L20 GPUs
  - 512 GB RAM
  - Intel Xeon Gold 6430
- **Software**:
  - Ubuntu 20.04 LTS
  - Python 3.8.10
  - CUDA 12.4
  - LLaMA-Factory 0.9.3.dev0

### ğŸ”½ Model Download

```bash
git lfs install
git clone https://huggingface.co/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
```

Or visit: https://huggingface.co/deepseek-ai

### ğŸš€ Training Setup

```bash
git clone --depth 1 https://github.com/hiyouga/LLaMA-Factory.git
conda create -n llama_factory python=3.8
conda activate llama_factory
cd LLaMA-Factory
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -e .[metrics]
llamafactory-cli version
```

Then follow the instructions in `deployment/README_DeepSeek_Finetuning.md`.

---

## ğŸ” Inference Format

```json
{
  "instruction": "Please analyze the following behavior sequence...",
  "input": "During working hours at Self_PC, logon, then access multiple websites (megaclick.com, linkedin.com)...",
  "output": "Anomaly Score = 1.00, Prediction = â€œAbnormalâ€"
}
```

---
